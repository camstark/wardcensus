<!DOCTYPE html>
<head>
    <title>Community map fill by housing type</title>
    <link rel="stylesheet" href="style.css" type="text/css" media="screen" />
</head>
<body>

<div id="main-wrapper">

	<div id="chart-wrapper">
		<svg class="chart"></svg>
			<div id="bartip" class="bartip">
				<h3 class="name"></h3>
				<div class="val"></div>
			</div>
	</div>	

    <div id="metrics">
        <div id="instruct"><em>Select one or more type of housing. <br/>Wards are coloured by most common among selection.</em></div>
    <!--    <div id="attributes"> -->
        <div id="housing">
            <h3>Calgary Housing Stock</h3>
            <ul>
         <!--   <li data-metric="attribute1" class="selected attribute1">One</li>
            <li data-metric="attribute2" class="selected attribute2">Two</li>
            <li data-metric="attribute3" class="selected attribute3">Three</li>
            <li data-metric="attribute4" class="selected attribute4">Four</li>
		-->	
	<!--		<li data-metric="SING_FAMLY" class="selected SING_FAMLY">Single Family</li>
            <li data-metric="APARTMENT" class="selected APARTMENT">Apartment</li>
            <li data-metric="TOWN_HOUSE" class="selected TOWN_HOUSE">Townhouse</li>
            <li data-metric="DUPLEX" class="selected DUPLEX">Duplex</li>
            <li data-metric="CONV_STRUC" class="selected CONV_STRUC">Converted Structure</li>
            <li data-metric="MULTI_PLEX" class="selected MULTI_PLEX">Multiplex</li>
	-->
			<li data-metric="SING_FAMLY_per" class="selected SING_FAMLY_per">Single Family</li>
            <li data-metric="APARTMENT_per" class="selected APARTMENT_per">Apartment</li>
            <li data-metric="TOWN_HOUSE_per" class="selected TOWN_HOUSE_per">Townhouse</li>
            <li data-metric="DUPLEX_per" class="selected DUPLEX_per">Duplex</li>
            <li data-metric="CONV_STRUC_per" class="selected CONV_STRUC_per">Converted Structure</li>
            <li data-metric="MULTI_PLEX_per" class="selected MULTI_PLEX_per">Multiplex</li>
			
            </ul>
        </div>
<!--
        <div id="non-motor">
            <h3>Non-motor Vehicle</h3>
            <ul>
                <li data-metric="HC01_EST_VC11" class="selected HC01_EST_VC11">Walk</li>
                <li data-metric="HC01_EST_VC12" class="selected HC01_EST_VC12">Bicycle</li>
                <li data-metric="HC01_EST_VC14" class="selected HC01_EST_VC14">Work from Home</li>
            </ul>
        </div>
-->
	

        <div class="clr"></div>
    </div><!-- @end #metrics -->

    <div id="tooltip" class="tooltip">
        <h3 class="name"></h3>
        <div data-metric="SING_FAMLY" class="line">
            <div class="SING_FAMLY symbol"></div> Single Family 
            <div class="SING_FAMLY_per per"></div>
            <div class="SING_FAMLY_val val"></div>
        </div>
        <div data-metric="APARTMENT" class="line">
            <div class="APARTMENT symbol"></div> Apartment
            <div class="APARTMENT_per per"></div>
            <div class="APARTMENT_val val"></div>
        </div>
        <div data-metric="TOWN_HOUSE" class="line">
            <div class="TOWN_HOUSE symbol"></div> Townhouse
            <div class="TOWN_HOUSE_per per"></div>
            <div class="TOWN_HOUSE_val val"></div>
        </div>
        <div data-metric="DUPLEX" class="line">
            <div class="DUPLEX symbol"></div> Duplex
            <div class="DUPLEX_per per"></div>
            <div class="DUPLEX_val val"></div>
        </div>
        <div data-metric="CONV_STRUC" class="line">
            <div class="CONV_STRUC symbol"></div> Converted Structure
            <div class="CONV_STRUC_per per"></div>
            <div class="CONV_STRUC_val val"></div>
        </div>
        <div data-metric="MULTI_PLEX" class="line">
            <div class="MULTI_PLEX symbol"></div> Multiplex
            <div class="MULTI_PLEX_per per"></div>
            <div class="MULTI_PLEX_val val"></div>
        </div>
    </div>	
	
    
</div><!-- @end #main-wrapper -->


<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>

<script>
//var width = 960,
//    height = 600,
//    center = [width / 2, height / 2],
//    defaultFill = "#e0e0e0";

var width = 500,
	height = 600,
	defaultFill = "#e0e0e0",
	active = d3.select(null);
    
var commByNum = d3.map();

var projection = d3.geo.azimuthalEqualArea()
	.rotate([100, -45,10])
	.center([-9.9,5.16])
	.scale(95000)
	//.scale(500)
	.translate([width/2, height/2])
	;

var path = d3.geo.path()
    .projection(projection);

// Color scale
//var color = d3.scale.linear().domain([0,100]).range(["#ffffff", "#8dd3c7"]).interpolate(d3.interpolateLab);
/*
var baseColors = { 
    "attribute1": d3.scale.linear().domain([0,100]).range(["#ffffff", "#8dd3c7"]).interpolate(d3.interpolateLab),
    "attribute2": d3.scale.linear().domain([0,100]).range(["#ffffff", "#bc80bd"]).interpolate(d3.interpolateLab),
    "attribute3": d3.scale.linear().domain([0,100]).range(["#ffffff", "#bebada"]).interpolate(d3.interpolateLab),
    "attribute4": d3.scale.linear().domain([0,100]).range(["#ffffff", "#fb8072"]).interpolate(d3.interpolateLab),
};
*/
//var baseColors = { 
//    "SING_FAMLY": d3.scale.linear().domain([0,100]).range(["#ffffff", "#386cb0"]).interpolate(d3.interpolateLab),
//    "DUPLEX": d3.scale.linear().domain([0,100]).range(["#ffffff", "#beaed4"]).interpolate(d3.interpolateLab),
//    "MULTI_PLEX": d3.scale.linear().domain([0,100]).range(["#ffffff", "#ffff99"]).interpolate(d3.interpolateLab),
//    "APARTMENT": d3.scale.linear().domain([0,100]).range(["#ffffff", "#f0027f"]).interpolate(d3.interpolateLab),
//    "TOWN_HOUSE": d3.scale.linear().domain([0,100]).range(["#ffffff", "#7fc97f"]).interpolate(d3.interpolateLab),
//    "CONV_STRUC": d3.scale.linear().domain([0,100]).range(["#ffffff", "#fdc086"]).interpolate(d3.interpolateLab),
//};
var baseColors = { 
    "SING_FAMLY_per": d3.scale.linear().domain([0,100]).range(["#ffffff", "#386cb0"]).interpolate(d3.interpolateLab),
    "DUPLEX_per": d3.scale.linear().domain([0,100]).range(["#ffffff", "#beaed4"]).interpolate(d3.interpolateLab),
    "MULTI_PLEX_per": d3.scale.linear().domain([0,100]).range(["#ffffff", "#ffff99"]).interpolate(d3.interpolateLab),
    "APARTMENT_per": d3.scale.linear().domain([0,100]).range(["#ffffff", "#f0027f"]).interpolate(d3.interpolateLab),
    "TOWN_HOUSE_per": d3.scale.linear().domain([0,100]).range(["#ffffff", "#7fc97f"]).interpolate(d3.interpolateLab),
    "CONV_STRUC_per": d3.scale.linear().domain([0,100]).range(["#ffffff", "#fdc086"]).interpolate(d3.interpolateLab),
};



var svg = d3.select("body #main-wrapper").append("svg")
    .attr("width", width)
    .attr("height", height)
	//.style("border", "1px solid black")
	;

var g = svg.append("g");

var tooltip = d3.select("#tooltip")
 .attr("class", "tooltip")
 .style("opacity", 0);
 
 ///////////////////// For zoom to feature
 
 		svg.append("rect")
			.attr("class", "background")
			.attr("width", width)
			.attr("height", height)
			.style("fill", "none")
			.on("click", reset);
			
		//var g = svg.append("g")
		//	.style("stroke-width", "1.5px");

	function clicked(d) {
	  if (active.node() === this) return reset();
	  active.classed("active", false);
	  active = d3.select(this).classed("active", true);

	  var bounds = path.bounds(d),
		  dx = bounds[1][0] - bounds[0][0],
		  dy = bounds[1][1] - bounds[0][1],
		  x = (bounds[0][0] + bounds[1][0]) / 2,
		  y = (bounds[0][1] + bounds[1][1]) / 2,
		  scale = .7 / Math.max(dx / width, dy / height),
		  translate = [width / 2 - scale * x, height / 2 - scale * y];

	  g.transition()
		  .duration(750)
		  .style("stroke-width", 1.5 / scale + "px")
		  .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
	}
	
	function reset() {
	  active.classed("active", false);
	  active = d3.select(null);

	  g.transition()
		  .duration(750)
		  .style("stroke-width", "1.5px")
		  .attr("transform", "");
	}
 
 
 //////////////////////

//var CURR_SELECT = ["attribute1"];
//var CURR_SELECT = ["attribute1","attribute2","attribute3","attribute4"];
//var CURR_SELECT = ["SING_FAMLY","DUPLEX","MULTI_PLEX","APARTMENT","TOWN_HOUSE","CONV_STRUC"];
var CURR_SELECT = ["SING_FAMLY_per","DUPLEX_per","MULTI_PLEX_per","APARTMENT_per","TOWN_HOUSE_per","CONV_STRUC_per"];


// Load data
queue()
    //.defer(d3.json, "data/wards.json")
    .defer(d3.json, "data/communities.json")
    //.defer(d3.json, "data/us.json")
    //.defer(d3.csv, "data/commute_subset_moe.csv", typeAndSet)
    //.defer(d3.csv, "data/warddatatest.csv", typeAndSet)
    //.defer(d3.csv, "data/CENSUS_WARD_2014.csv", processWardData)
    .defer(d3.tsv, "data/communitydata.tsv", processCommunityData)
    .await(ready);

// After loading the data...
function ready(error, wards) {

    // County borders
    g.append("g")
        .attr("class", "counties")
        .selectAll("path")
          .data(topojson.feature(wards, wards.objects.collection).features)  //replace "counties" with "collection"
        .enter().append("path")
          .attr("d", path)
		  
		  .on("mouseover", mouseover)
		.on("mouseout", function() {
			d3.select(this).classed("selected", false);
			tooltip.transition().duration(300)
			  .style("opacity", 0);
			})
		.on("click", clicked)
		;
	
					/*			var wards = g.selectAll(".ward") // create SVG path element
								.data(topojson.feature(
									wardGeom,wardGeom.objects.collection).features)
								.enter() //create elements for each community
								.append("path") // append elements to svg
								.attr("class", "wards") //class name for styling  -- use "community" for ugly colours to distinguish from above.
								.attr("id", function(d) { return "YYC" + d.properties.WARD_NUM })
								.attr("d", path) //project data as geometry in svg
								//.style("fill", function(d) {return commTypeColors[d.properties.CLASS]})
								.style("fill", "grey")
								.style("stroke-width", ".5px")
								  //.attr("class", "feature") //Adding these two lines
								  .on("click", clicked)		//for click-zoom...
								.on("mouseover", highlight)
								.on("mouseout", dehighlight)
								.on("mousemove", moveLabel)
								.append("desc")
									.text(function(d) {
										return "grey"})
										//return commTypeColors[d.properties.CLASS]})
								;
						*/
    // State borders
    g.append("path")
        .datum(topojson.mesh(wards, wards.objects.collection, function(a, b) { return a !== b; }))
        .attr("class", "states")
        .attr("d", path);
    
    // Update county fill colors based on current selection
    updateClasses();
	
    // Make filter buttons interactive
    d3.selectAll("#metrics li")
        .on("click", function() {
            var item = d3.select(this);
            if (item.classed("selected")) {
                item.attr("class", "");
                removeFromArray(CURR_SELECT, item.attr("data-metric"));
                
            } else {
                item.classed("selected " + item.attr("data-metric"), true);
                CURR_SELECT.push(item.attr("data-metric"));
            }

            updateClasses();
        });

}

function mouseover(d) {
			 d3.select(this).classed("selected", true);
			 tooltip.transition().duration(100)
			   .style("opacity", 1)
			 if (d3.event.pageX > (width - 200)) {
				 tooltip.style("left", (d3.event.pageX - 210) + "px");
			 } else {
				 tooltip.style("left", (d3.event.pageX + 20) + "px")
					  .style("top", (d3.event.pageY -30) + "px");
			 }
			 if (d3.event.pageY > (height - 150)) {
				 tooltip.style("top", (d3.event.pageY -140) + "px");
			 } else {
				 tooltip.style("top", (d3.event.pageY -30) + "px");
			 }

			 //tooltip.select(".name").text(wardByNum.get(d.properties.WARD_NUM)['name']);
			 //tooltip.select(".name").text(wardByNum.get(d.properties.WARD_NUM)['LABEL']);
			 tooltip.select(".name").text(commByNum.get(d.properties.COMM_CODE)['NAME']);
			 tooltip.select(".SING_FAMLY_per.per").text(d3.round(commByNum.get(d.properties.COMM_CODE)["SING_FAMLY_per"])  + "%")
			 tooltip.select(".DUPLEX_per.per").text(d3.round(commByNum.get(d.properties.COMM_CODE)["DUPLEX_per"])  + "%")
			 tooltip.select(".MULTI_PLEX_per.per").text(d3.round(commByNum.get(d.properties.COMM_CODE)["MULTI_PLEX_per"])  + "%")			 
			 tooltip.select(".APARTMENT_per.per").text(d3.round(commByNum.get(d.properties.COMM_CODE)["APARTMENT_per"])  + "%")			 
			 tooltip.select(".TOWN_HOUSE_per.per").text(d3.round(commByNum.get(d.properties.COMM_CODE)["TOWN_HOUSE_per"])  + "%")			 
			 tooltip.select(".CONV_STRUC_per.per").text(d3.round(commByNum.get(d.properties.COMM_CODE)["CONV_STRUC_per"])  + "%")
			 			 
 			 tooltip.select(".SING_FAMLY_val.val").text(d3.round(commByNum.get(d.properties.COMM_CODE)["SING_FAMLY"]))
			 tooltip.select(".DUPLEX_val.val").text(d3.round(commByNum.get(d.properties.COMM_CODE)["DUPLEX"]))
			 tooltip.select(".MULTI_PLEX_val.val").text(d3.round(commByNum.get(d.properties.COMM_CODE)["MULTI_PLEX"]))			 
			 tooltip.select(".APARTMENT_val.val").text(d3.round(commByNum.get(d.properties.COMM_CODE)["APARTMENT"]))			 
			 tooltip.select(".TOWN_HOUSE_val.val").text(d3.round(commByNum.get(d.properties.COMM_CODE)["TOWN_HOUSE"]))			 
			 tooltip.select(".CONV_STRUC_val.val").text(d3.round(commByNum.get(d.properties.COMM_CODE)["CONV_STRUC"]))

}

function updateClasses() {
    svg.selectAll(".counties path")
    //    .attr("fill", function(d) { return color(wardByNum.get(d.properties.WARD_NUM).attribute1); });
        //.attr("fill", function(d) { return colorByGreatest(d.properties.WARD_NUM); });
        .attr("fill", function(d) { return colorByGreatest(d.properties.COMM_CODE); });
	//	.attr("fill", function(d) {  console.log(d.properties.WARD_NUM); })
		;
}

//function colorByGreatest(WARD_NUM) {
function colorByGreatest(COMM_CODE) {
    
    //var wardObject = wardByNum.get(WARD_NUM);
    var wardObject = commByNum.get(COMM_CODE);
	//console.log(wardObject.CLASS);
   if (typeof wardObject !== "undefined") {
			if (wardObject.CLASS === "Residential") {
				var values = [];
				for (var i = 0; i < CURR_SELECT.length; i++) {
					values.push(wardObject[CURR_SELECT[i]]);
				}
				var maxValue = d3.max(values);
				var maxIndex = values.indexOf(maxValue);
				var metric = CURR_SELECT[maxIndex];
				//return baseColors[metric](maxValue); IF ELSE BELOW TO DEAL WITH CHOOSING NONE
				if (metric === undefined){ return defaultFill; }
					else { return baseColors[metric](maxValue); }
			}
					else {
				return "#ffffff";
				//return "#f0f0f0";
			}
}    
    else {
        return "#ffffff";
		//return "#f0f0f0";

    }
   
}

function typeAndSet(d) {
	d.attribute1 = +d.attribute1;
	d.attribute2 = +d.attribute2;
	d.attribute3 = +d.attribute3;
	d.attribute4 = +d.attribute4;
	wardByNum.set(d.WARD_NUM, d);
}

function processWardData(d) {

	d.SING_FAMLY = +d.SING_FAMLY / +d.DWELL_CNT * 100;
	d.DUPLEX = +d.DUPLEX / +d.DWELL_CNT * 100;
	d.MULTI_PLEX = +d.MULTI_PLEX / +d.DWELL_CNT * 100;
	d.APARTMENT = +d.APARTMENT / +d.DWELL_CNT * 100;
	d.TOWN_HOUSE = +d.TOWN_HOUSE / +d.DWELL_CNT * 100;
	d.CONV_STRUC = +d.CONV_STRUC / +d.DWELL_CNT * 100;
	wardByNum.set(d.WARD_NUM, d);
}

function processCommunityData(d) {

	d.SING_FAMLY = +d.SING_FAMLY;
	d.DUPLEX = +d.DUPLEX;
	d.MULTI_PLEX = +d.MULTI_PLEX;
	d.APARTMENT = +d.APARTMENT;
	d.TOWN_HOUSE = +d.TOWN_HOUSE;
	d.CONV_STRUC = +d.CONV_STRUC;
	d.DWELL_CNT = +d.DWELL_CNT;
	d.SING_FAMLY_per = +d.SING_FAMLY / +d.DWELL_CNT * 100;
	d.DUPLEX_per = +d.DUPLEX / +d.DWELL_CNT * 100;
	d.MULTI_PLEX_per = +d.MULTI_PLEX / +d.DWELL_CNT * 100;
	d.APARTMENT_per = +d.APARTMENT / +d.DWELL_CNT * 100;
	d.TOWN_HOUSE_per = +d.TOWN_HOUSE / +d.DWELL_CNT * 100;
	d.CONV_STRUC_per = +d.CONV_STRUC / +d.DWELL_CNT * 100;
	commByNum.set(d.COMM_CODE, d);
	//console.log(d.COMM_CODE);
	//console.log(d.NAME)
	return d;
}

// Removes values from an array
function removeFromArray(arr) {
    var what, a = arguments, L = a.length, ax;
    while (L > 1 && arr.length) {
        what = a[--L];
        while ((ax= arr.indexOf(what)) !== -1) {
            arr.splice(ax, 1);
        }
    }
    return arr;
}

//barchart

var width = 550,
    height = 200;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var chart = d3.select(".chart")
    .attr("width", width)
    .attr("height", height);

var barcolor = d3.scale.ordinal()
    //.range(["#386cb0", "#f0027f", "#7fc97f", "#beaed4", "#fdc086", "#ffff99"]);
    .range(["#386cb0", "#beaed4", "#ffff99", "#f0027f", "#7fc97f", "#fdc086"]);
	
var bartip = d3.select("#bartip")
 .attr("class", "bartip")
 .style("opacity", 0);

 
 
d3.tsv("data/communitydata.tsv", processCommunityData, function(error, data) {


 barcolor.domain(d3.keys(data[0]).filter(function(key) { return key === "SING_FAMLY" | 
																key === "APARTMENT" |
																key === "TOWN_HOUSE" |
																key === "DUPLEX" |
																key === "CONV_STRUC" |
																key === "MULTI_PLEX" 
																; }));
 
 
   data.forEach(function(d) {
    var y0 = 0;
    d.dwelltypes = barcolor.domain().map(function(name) { return {comm: d.NAME, name: name, y0: y0, y1: y0 += +d[name]}; });
    d.total = d.dwelltypes[d.dwelltypes.length - 1].y1;
	//console.log(d.dwelltypes);
  });

  data.sort(function(a, b) { return b.total - a.total; });

  x.domain(data.map(function(d) { if(d.CLASS === "Residential"){return d.NAME;} }));
  y.domain([0, d3.max(data, function(d) { return d.total; })]);

  var bar = chart.selectAll("g")
      .data(data)
    .enter().append("g")
      .attr("transform", function(d) { if(d.CLASS === "Residential") {return "translate(" + x(d.NAME) + ",0)"; }})
	  .attr("id", function(d) { return "bar" + d.NAME;})
	  ;

 // bar.append("rect")
 //     .attr("y", function(d) { return y(d.total); })
 //     .attr("height", function(d) { return height - y(d.total); })
 //     .attr("width", x.rangeBand())
//	;
  
  bar.selectAll("rect")
      .data(function(d) { return d.dwelltypes; })
    .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.y1); })
      .attr("height", function(d) { return y(d.y0) - y(d.y1); })
      .style("fill", function(d) { return barcolor(d.name); })
	  .on("mouseover", barmouseover)
	  .on("mouseout", function() {
			d3.select(this).classed("selected", false);
			bartip.transition().duration(300)
			  .style("opacity", 0);
			})
	  ;
	
/*  bar.append("text")
      .attr("x", x.rangeBand() / 2)
      .attr("y", function(d) { return y(d.total) + 3; })
      .attr("dy", ".75em")
      .text(function(d) { return d.NAME });
*/

});

function barmouseover(d) {
			 d3.select(this).classed("selected", true);
			 bartip.transition().duration(100)
			   .style("opacity", 1)
			// if (d3.event.pageX > (width - 200)) {
			//	 bartip.style("left", (d3.event.pageX - 210) + "px");
			// } else {
				 bartip.style("left", (d3.event.pageX + 20) + "px")
					  .style("top", (d3.event.pageY -30) + "px");
			// }
			// if (d3.event.pageY > (height - 150)) {
			//	 bartip.style("top", (d3.event.pageY -140) + "px");
			// } else {
				 bartip.style("top", (d3.event.pageY -30) + "px");
			 //}
		
			 bartip.select(".name").text(d.comm);
			 bartip.select(".val").text(d.name);
			 
			 	
}




</script>
</body>
</html>